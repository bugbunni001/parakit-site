<div id="dashboardData">
    <div class="card" id="dailyCard">
        <div class="card-header">
            <span>üìÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <span id="dailyDateNum">-</span>)</span>
            <span id="labelStaff" style="font-size: 14px; background: rgba(0,0,0,0.2); padding: 4px 12px; border-radius: 6px;"></span>
        </div>
        <div class="table-wrapper">
            <table class="daily-table" id="tableDaily">
                <thead>
                    <tr>
                        <th rowspan="2" style="background:#4a5568; color:white; min-width: 80px; text-align:center;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                        <th colspan="2" class="bg-amber" style="color:white; text-align:center;">New Post</th>
                        <th colspan="2" class="bg-orange" style="color:white; text-align:center;">BDBC</th>
                        <th colspan="2" class="bg-slate" style="color:white; text-align:center;">Apple</th>
                        <th colspan="2" class="bg-teal" style="color:white; text-align:center;">SmartPhone</th>
                        <th colspan="2" style="background:#2d3748; color:white; text-align:center;">Total</th>
                    </tr>
                    <tr style="background: #f1f5f9; text-align:center;">
                        <th class="v-sep">Actual</th><th>Diff</th>
                        <th class="v-sep">Actual</th><th>Diff</th>
                        <th class="v-sep">Actual</th><th>Diff</th>
                        <th class="v-sep">Actual</th><th>Diff</th>
                        <th class="v-sep">Post</th><th>Device</th>
                    </tr>
                </thead>
                <tbody id="dailyBody" style="text-align:center;"></tbody>
            </table>
        </div>
    </div>

    <div class="card" id="saleDetailsCard">
        <div class="card-header" style="background: #475569;">
            <span>üë§ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (‡∏£‡∏≤‡∏¢‡∏Ñ‡∏ô/‡∏£‡∏≤‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)</span>
        </div>
        <div class="table-wrapper">
            <table id="tableSaleDetails">
                <thead>
                    <tr style="background: #f8fafc;">
                        <th style="width: 200px;">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
                        <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                        <th>‡∏£‡∏∏‡πà‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                        <th class="text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                        <th class="text-right">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</th>
                    </tr>
                </thead>
                <tbody id="saleDetailsBody">
                    </tbody>
            </table>
        </div>
    </div>

    <div class="main-grid">
        </div>
</div>

<script>
    // [‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏° loadSidebar, toggleSidebar ‡∏•‡πá‡∏≠‡∏Ñ‡πÑ‡∏ß‡πâ]

    async function loadData() {
        const loader = document.getElementById('loader');
        const selectedDay = document.getElementById('daySelect').value;
        if(!selectedDay) return alert("‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà");

        loader.style.display = 'flex';
        try {
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å URL ‡∏Ç‡∏≠‡∏á‡∏ö‡∏≠‡∏¢
            const res = await fetch(`${SCRIPT_URL}?sheetName=SHOP&targetDay=${selectedDay}`);
            const data = await res.json();

            if(data.result === "success") {
                // --- ‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏î‡∏¥‡∏° (‡∏•‡πá‡∏≠‡∏Ñ‡πÑ‡∏ß‡πâ) ---
                document.getElementById('labelL').innerText = data.staffName;
                document.getElementById('labelR').innerText = data.staffName;
                document.getElementById('labelStaff').innerText = data.staffName;
                document.getElementById('dailyDateNum').innerText = selectedDay;

                document.getElementById('summaryBody').innerHTML = data.summary.map(r => {
                    const isTotal = r[0].includes("‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î");
                    return `<tr class="${isTotal?'row-summary':''}"><td>${r[0]}</td><td class="text-right">${r[1]}</td><td class="text-right">${r[2]}</td></tr>`;
                }).join('');

                document.getElementById('brandBody').innerHTML = data.brandSummary.map(r => {
                    const isTotal = r[0].includes("‡∏£‡∏ß‡∏°");
                    const rowStyle = isTotal ? 'font-weight:700; background:#f1f5f9;' : '';
                    return `<tr style="${rowStyle}"><td>${r[0]}</td><td class="text-right">${r[1]}</td><td class="text-right">${r[2]}</td></tr>`;
                }).join('');

                // --- [‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ï‡∏±‡∏ß ---
                const detailsBody = document.getElementById('saleDetailsBody');
                if (data.saleDetails && data.saleDetails.length > 0) {
                    detailsBody.innerHTML = data.saleDetails.map(r => `
                        <tr>
                            <td style="font-weight:500; color:var(--primary);">${r.staff || r[0]}</td>
                            <td><span style="background:#edf2f7; padding:2px 8px; border-radius:4px; font-size:12px;">${r.type || r[1]}</span></td>
                            <td>${r.model || r[2]}</td>
                            <td class="text-right"><b>${r.qty || r[3]}</b></td>
                            <td class="text-right">${r.amount || r[4] || '-'}</td>
                        </tr>
                    `).join('');
                } else {
                    detailsBody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px; color:#a0aec0;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</td></tr>`;
                }

                // --- ‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏•‡πá‡∏≠‡∏Ñ‡πÑ‡∏ß‡πâ) ---
                // (‡πÇ‡∏Ñ‡πâ‡∏î‡∏î‡∏∂‡∏á target, dailyRow, topStats ‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏¥‡∏°)
                if(data.dailyRow) {
                    const dr = data.dailyRow;
                    document.getElementById('dailyBody').innerHTML = `
                        <tr><td style="background:#f8fafc;">${dr[0]}</td>
                        <td class="v-sep val-actual">${dr[1]}</td><td class="val-diff">${dr[2]}</td>
                        <td class="v-sep val-actual">${dr[3]}</td><td class="val-diff">${dr[4]}</td>
                        <td class="v-sep val-actual">${dr[5]}</td><td class="val-diff">${dr[6]}</td>
                        <td class="v-sep val-actual">${dr[7]}</td><td class="val-diff">${dr[8]}</td>
                        <td class="v-sep"><b>${dr[9]}</b></td><td><b>${dr[10]}</b></td></tr>`;
                }

                document.getElementById('dashboardData').style.display = 'block';
                document.getElementById('noData').style.display = 'none';
            }
        } catch (e) { 
            console.error(e);
            alert("‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); 
        } finally { 
            loader.style.display = 'none'; 
        }
    }

    // [‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô exportPDF ‡πÅ‡∏•‡∏∞ exportExcel ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô Excel]
    function exportExcel() {
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, XLSX.utils.table_to_sheet(document.getElementById('tableDaily')), "Daily");
        XLSX.utils.book_append_sheet(wb, XLSX.utils.table_to_sheet(document.getElementById('tableSaleDetails')), "Sale_Details"); // ‡πÄ‡∏û‡∏¥‡πà‡∏° Sheet ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
        XLSX.utils.book_append_sheet(wb, XLSX.utils.table_to_sheet(document.getElementById('tableSummary')), "Summary");
        XLSX.utils.book_append_sheet(wb, XLSX.utils.table_to_sheet(document.getElementById('tableBrand')), "Brands");
        XLSX.writeFile(wb, "Performance_Report.xlsx");
    }
</script>
