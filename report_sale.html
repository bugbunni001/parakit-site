<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --sidebar-color: #1e293b;
            --text-main: #334155;
            --sidebar-width: 280px;
            --luxury-blue: #0f172a;
            --border-color: #e2e8f0;
            --head-daily: #334155;
            --head-detail: #0284c7;
            --head-mtd: #059669;
            --head-focus: #1e293b;
            --head-target: #b45309;
            --success: #10b981;
            --danger: #ef4444;
        }

        * { box-sizing: border-box; font-family: 'Kanit', sans-serif !important; }
        body { margin: 0; background: #f1f5f9; color: var(--text-main); transition: padding-left 0.3s; }
        .top-header { position: fixed; top: 0; left: 0; right: 0; height: 65px; background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); z-index: 1100; display: flex; align-items: center; padding: 0 20px; border-bottom: 1px solid #e2e8f0; }
        .top-toggle { width: 40px; height: 40px; border-radius: 10px; border: none; background: var(--sidebar-color); color: white; cursor: pointer; margin-right: 15px; }
        .sidebar { position: fixed; top: 0; left: 0; width: var(--sidebar-width); height: 100vh; background: var(--sidebar-color); color: #fff; transition: transform .3s; z-index: 2000; overflow-y: auto; }
        
        @media(min-width:769px) { body:not(.collapsed) { padding-left: var(--sidebar-width); } body.collapsed .sidebar { transform: translateX(-100%); } }
        @media(max-width:768px) { .sidebar { transform: translateX(-100%); } .sidebar.show { transform: translateX(0); } }

        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; z-index: 1500; }
        .overlay.show { display: block; }

        .main-wrapper { padding: 85px 20px 40px; }
        .toolbar { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; justify-content: flex-end; gap: 15px; margin-bottom: 25px; border: 1px solid var(--border-color); }
        .modern-select, .modern-date { padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1; outline: none; }
        .btn-fetch { background: var(--luxury-blue); color: white; border: none; padding: 10px 25px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-fetch:hover { opacity: 0.9; transform: translateY(-1px); }

        .card { background: white; border-radius: 12px; overflow: hidden; border: 1px solid var(--border-color); margin-bottom: 25px; }
        .card-header-bar { padding: 14px 20px; color: white; font-weight: 500; display: flex; justify-content: space-between; align-items: center; }
        .bg-daily { background: var(--head-daily); }
        .bg-detail { background: var(--head-detail); }
        .bg-mtd { background: var(--head-mtd); }
        .bg-extra { background: #475569; }
        
        .table-luxury { width: 100%; border-collapse: collapse; }
        .table-luxury th { background: #f8fafc; padding: 12px; text-align: left; font-size: 13px; border-bottom: 2px solid var(--border-color); color: #64748b; }
        .table-luxury td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
        .up { color: var(--success); font-weight: 600; } 
        .down { color: var(--danger); font-weight: 600; }

        .grid-container { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; }
        .mtd-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 20px; }
        .stat-box { padding: 15px; border-radius: 10px; border: 1px solid #e2e8f0; border-left: 6px solid; }
        
        #loader { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--luxury-blue); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @media (max-width: 1000px) { .grid-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<header class="top-header">
    <button class="top-toggle" onclick="toggleSidebar()">‚ò∞</button>
    <div style="font-weight:600;">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ By Indy</div>
</header>

<div class="overlay" id="overlay" onclick="toggleSidebar()"></div>
<aside class="sidebar" id="sidebar"></aside>

<div id="loader">
    <div class="spinner"></div>
    <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
</div>

<div class="main-wrapper">
    <div class="toolbar">
        <select id="name" class="modern-select">
            <option>‡∏ô‡∏ß‡∏û‡∏•</option>
            <option>‡∏õ‡∏¥‡∏¢‡∏∞‡∏û‡∏£</option>
            <option>‡∏Å‡∏£‡∏ó‡∏±‡∏Å‡∏©‡πå</option>
        </select>
        <input type="date" id="day" class="modern-date">
        <button class="btn-fetch" onclick="pullData()">üöÄ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>

    <div id="welcome-card" style="text-align:center; padding:150px 20px; border:2px dashed #cbd5e1; border-radius:16px; background:#fff;">
        <h3>üìä ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
    </div>

    <div id="dashboard" style="display:none;">
        <div class="card">
            <div class="card-header-bar bg-daily">
                <span>üìâ ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</span>
                <span id="out-date" style="background:rgba(255,255,255,0.2); padding:4px 10px; border-radius:5px;"></span>
            </div>
            <div style="overflow-x:auto;">
                <table class="table-luxury">
                    <thead>
                        <tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>New Post</th><th>Diff</th><th>BDBC</th><th>Diff</th><th>Apple</th><th>Smart</th><th>‡∏£‡∏ß‡∏° P</th><th>‡∏£‡∏ß‡∏° D</th></tr>
                    </thead>
                    <tbody id="body-daily"></tbody>
                </table>
            </div>
        </div>

        <div class="grid-container">
            <div class="col-left">
                <div class="card">
                    <div class="card-header-bar bg-detail">üìë ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: <span class="out-name"></span></div>
                    <table class="table-luxury" id="tbl-sum">
                        <thead><tr><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏ö‡∏≤‡∏ó</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="card">
                    <div class="card-header-bar bg-mtd">üöÄ ‡∏¢‡∏≠‡∏î‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                    <div class="mtd-grid" id="out-actual"></div>
                </div>

                <div class="card">
                    <div class="card-header-bar bg-extra">üìä ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏© (Extra Stats)</div>
                    <table class="table-luxury">
                        <thead><tr><th>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th><th>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th></tr></thead>
                        <tbody id="body-extra"></tbody>
                    </table>
                </div>
            </div>

            <div class="col-right">
                <div class="card">
                    <div class="card-header-bar bg-daily">üõí ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö (‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)</div>
                    <div style="overflow-x:auto;">
                        <table class="table-luxury">
                            <thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th></tr></thead>
                            <tbody id="body-web"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwpnINaswUgJi4W3JzwVbEfKnIkn8Qn5lFAghEFzdWCe9r41VfaOJcWY27pYwSxurUtYQ/exec";

    function toggleSidebar() {
        if (window.innerWidth <= 768) {
            document.getElementById("sidebar").classList.toggle("show");
            document.getElementById("overlay").classList.toggle("show");
        } else {
            document.body.classList.toggle("collapsed");
        }
    }

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏´‡πâ input
    window.onload = () => {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('day').value = today;
    };

    async function pullData() {
        const loader = document.getElementById('loader');
        loader.style.display = 'flex';
        try {
            const name = document.getElementById('name').value;
            const dayInput = document.getElementById('day').value;
            const dayNum = new Date(dayInput).getDate();

            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 2 ‡∏™‡πà‡∏ß‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
            const [salesRes, webRes] = await Promise.all([
                fetch(`${WEB_APP_URL}?action=getSales&name=${name}&day=${dayNum}`).then(r => r.json()),
                fetch(`${WEB_APP_URL}?action=getWebDetails&day=${dayInput}`).then(r => r.json())
            ]);

            if (salesRes.success) {
                renderDashboard(salesRes);
                renderWebTable(webRes, name);
                document.getElementById('welcome-card').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
            } else {
                alert("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + salesRes.error);
            }
        } catch (e) {
            alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: " + e.message);
        }
        loader.style.display = 'none';
    }

    function renderDashboard(data) {
        document.querySelectorAll('.out-name').forEach(el => el.innerText = data.name);
        document.getElementById('out-date').innerText = data.daily.date;
        
        const getClr = (v) => v.toString().includes('-') ? 'class="up"' : 'class="down"';
        const d = data.daily;
        
        // 1. ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
        document.getElementById('body-daily').innerHTML = `<tr>
            <td>${d.date}</td>
            <td>${d.np}</td><td><span ${getClr(d.npD)}>${d.npD}</span></td>
            <td>${d.bd}</td><td><span ${getClr(d.bdD)}>${d.bdD}</span></td>
            <td>${d.ap}</td><td>${d.sm}</td>
            <td><b>${d.totalP}</b></td><td><b>${d.totalD}</b></td>
        </tr>`;

        // 2. ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        document.querySelector('#tbl-sum tbody').innerHTML = data.summary.map(r => 
            r[0] ? `<tr><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td></tr>` : ''
        ).join('');

        // 3. ‡∏ï‡∏≤‡∏£‡∏≤‡∏á Extra Stats (B27:D38)
        document.getElementById('body-extra').innerHTML = data.extraStats.map(r => 
            r[0] ? `<tr><td>${r[0]}</td><td>${r[1]}</td><td style="color:#059669; font-weight:700;">${r[2]}</td></tr>` : ''
        ).join('');

        // 4. ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏¢‡∏≠‡∏î‡∏™‡∏∞‡∏™‡∏°
        const act = data.actuals;
        const boxes = [
            {l:'New Post', v:act.np, c:'#0284c7'}, {l:'BDBC', v:act.bd, c:'#059669'},
            {l:'Apple', v:act.ap, c:'#d97706'}, {l:'Smart', v:act.sm, c:'#be123c'}
        ];
        document.getElementById('out-actual').innerHTML = boxes.map(i => `
            <div class="stat-box" style="border-left-color:${i.c}">
                <div style="font-size:12px; color:#666">${i.l}</div>
                <div style="font-size:20px; font-weight:700;">${i.v.val}</div>
                <div style="font-size:11px;" ${getClr(i.v.diff)}>Diff: ${i.v.diff}</div>
                <div style="font-size:13px; margin-top:5px; color:#059669">Ach: ${i.v.ach}%</div>
            </div>
        `).join('');
    }

    function renderWebTable(data, empName) {
        const tbody = document.getElementById('body-web');
        // ‡∏Å‡∏£‡∏≠‡∏á‡∏¢‡∏≠‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà 2 ‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï)
        const filtered = data.rows.filter(r => r[1] === empName);
        
        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡πà‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</td></tr>';
        } else {
            tbody.innerHTML = filtered.map(r => `
                <tr><td>${r[0]}</td><td>${r[2]}</td><td>${r[3]}</td><td>${r[4]}</td></tr>
            `).join('');
        }
    }
</script>
</body>
</html>
