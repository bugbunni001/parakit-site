<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: #2c3e50;
      --accent-color: #3498db;
      --bg-color: #f4f7f6;
      --sidebar-width: 250px;
      --sidebar-collapsed-width: 70px;
    }
    body { font-family: 'Kanit', sans-serif; margin: 0; background-color: var(--bg-color); display: flex; transition: all 0.3s; }
    
    /* Sidebar */
    #sidebar { width: var(--sidebar-width); background: white; height: 100vh; position: fixed; box-shadow: 2px 0 5px rgba(0,0,0,0.05); transition: 0.3s; overflow: hidden; z-index: 1000; }
    #sidebar.collapsed { width: var(--sidebar-collapsed-width); }
    .content-area { margin-left: var(--sidebar-width); width: 100%; padding: 25px; transition: 0.3s; }
    .content-area.expanded { margin-left: var(--sidebar-collapsed-width); }

    /* Cards & UI */
    .card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); border: 1px solid #eee; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    h2 { font-size: 1.2rem; color: var(--primary-color); border-left: 4px solid var(--accent-color); padding-left: 10px; margin-bottom: 20px; }
    
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th { background: #f8f9fa; color: #7f8c8d; font-weight: 500; text-align: left; padding: 12px; border-bottom: 2px solid #eee; }
    td { padding: 12px; border-bottom: 1px solid #f1f1f1; font-size: 0.95rem; }
    
    select, button { padding: 10px 15px; border-radius: 8px; border: 1px solid #ddd; font-family: 'Kanit'; outline: none; transition: 0.3s; }
    button { background: var(--accent-color); color: white; border: none; cursor: pointer; font-weight: 500; }
    button:hover { background: #2980b9; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(52,152,219,0.3); }

    /* Loading Overlay */
    #loader-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--accent-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Status Color */
    .positive { color: #27ae60; font-weight: 500; }
    .negative { color: #e74c3c; font-weight: 500; }
    .badge { padding: 4px 8px; border-radius: 6px; background: #ebf5fb; color: #2980b9; font-size: 0.8rem; }
  </style>
</head>
<body>

  <div id="sidebar">
    <?!= include('sidebar'); ?>
  </div>

  <div id="main-content" class="content-area">
    <div class="card">
      <div style="display: flex; gap: 15px; align-items: center;">
        <select id="staffName">
          <option value="นวพล">นวพล</option>
          <option value="ปิยะพร">ปิยะพร</option>
          <option value="กรทักษ์">กรทักษ์</option>
        </select>
        <select id="daySelect">
          </select>
        <button onclick="fetchData()"><i class="fas fa-sync-alt"></i> ดึงข้อมูล</button>
      </div>
    </div>

    <div id="dailyResult" class="card" style="display:none;">
      <h2 id="dailyTitle">ยอดรายวัน</h2>
      <div style="overflow-x: auto;">
        <table id="tableDaily">
          <thead>
            <tr>
              <th>วันที่</th><th>New Post</th><th>Diff</th><th>BDBC</th><th>Diff</th><th>Apple</th><th>Diff</th><th>SmartPhone</th><th>Diff</th><th>รวม Post</th><th>รวม Device</th>
            </tr>
          </thead>
          <tbody id="bodyDaily"></tbody>
        </table>
      </div>
    </div>

    <div class="grid-2">
      <div id="summaryCard" class="card" style="display:none;">
        <h2 id="summaryTitle">สรุปยอด Postpay</h2>
        <table>
          <thead><tr><th>Type การขาย</th><th>ยอด PostPay</th><th>จำนวน</th></tr></thead>
          <tbody id="bodySummary"></tbody>
        </table>
      </div>
      
      <div>
        <div id="focusCard" class="card" style="display:none;">
          <h2 id="focusTitle">Focus</h2>
          <table>
            <thead><tr><th>Target</th><th>Actual</th></tr></thead>
            <tbody id="bodyFocus"></tbody>
          </table>
        </div>
        <div id="targetCard" class="card" style="display:none;">
          <h2>Target</h2>
          <tbody id="bodyTargetList"></tbody>
          <table id="tableTargetList"></table>
        </div>
      </div>
    </div>

    <div id="actualCard" class="card" style="display:none;">
      <h2 id="actualTitle">Actual ยอดสะสมเดือนนี้</h2>
      <div class="grid-2" style="grid-template-columns: repeat(4, 1fr);">
        <div id="boxNew"></div>
        <div id="boxBdbc"></div>
        <div id="boxApple"></div>
        <div id="boxSmart"></div>
      </div>
    </div>
  </div>

  <div id="loader-overlay">
    <div class="spinner"></div>
    <p style="margin-top:15px; color: #555;">ระบบกำลังดึงข้อมูลยอดขาย...</p>
  </div>

  <script>
    // Initialize Day Select
    const daySelect = document.getElementById('daySelect');
    for(let i=1; i<=31; i++) {
      let opt = document.createElement('option');
      opt.value = i;
      opt.innerHTML = 'วันที่ ' + i;
      daySelect.appendChild(opt);
    }

    // Sidebar Toggle Logic
    function toggleSidebar() {
      const sb = document.getElementById('sidebar');
      const mc = document.getElementById('main-content');
      sb.classList.toggle('collapsed');
      mc.classList.toggle('expanded');
      localStorage.setItem('sidebarState', sb.classList.contains('collapsed') ? 'closed' : 'open');
    }

    // Load Sidebar State
    window.onload = () => {
      if(localStorage.getItem('sidebarState') === 'closed') toggleSidebar();
    };

    function fetchData() {
      const staff = document.getElementById('staffName').value;
      const day = document.getElementById('daySelect').value;
      document.getElementById('loader-overlay').style.display = 'flex';

      google.script.run
        .withSuccessHandler(renderData)
        .withFailureHandler(err => {
          alert("Error: " + err.message);
          document.getElementById('loader-overlay').style.display = 'none';
        })
        .getData(staff, day);
    }

    function renderData(data) {
      const staff = document.getElementById('staffName').value;
      
      // Daily Table
      const d = data.daily;
      document.getElementById('bodyDaily').innerHTML = `
        <tr>
          <td>${d.date}</td>
          <td>${d.newPost.toLocaleString()}</td>
          <td class="${d.diffNew < 0 ? 'negative':'positive'}">${d.diffNew.toLocaleString()}</td>
          <td>${d.bdbc.toLocaleString()}</td>
          <td class="${d.diffBdbc < 0 ? 'negative':'positive'}">${d.diffBdbc.toLocaleString()}</td>
          <td>${d.apple.toLocaleString()}</td>
          <td class="${d.diffApple < 0 ? 'negative':'positive'}">${d.diffApple.toLocaleString()}</td>
          <td>${d.smart.toLocaleString()}</td>
          <td class="${d.diffSmart < 0 ? 'negative':'positive'}">${d.diffSmart.toLocaleString()}</td>
          <td><b>${d.sumPost.toLocaleString()}</b></td>
          <td><b>${d.sumDevice.toLocaleString()}</b></td>
        </tr>
      `;

      // Summary Table
      document.getElementById('summaryTitle').innerText = 'สรุปยอด Postpay : ' + staff;
      let sumHtml = '';
      data.summary.forEach(r => {
        if(r[0]) sumHtml += `<tr><td>${r[0]}</td><td>${r[1].toLocaleString()}</td><td>${r[2]}</td></tr>`;
      });
      document.getElementById('bodySummary').innerHTML = sumHtml;

      // Focus Table
      document.getElementById('focusTitle').innerText = 'Focus : ' + staff;
      let focusHtml = '';
      data.focus.forEach(r => {
        focusHtml += `<tr><td>${r[0]}</td><td>${r[1]}</td></tr>`;
      });
      document.getElementById('bodyFocus').innerHTML = focusHtml;

      // Target List
      let targetHtml = '';
      data.targetList.forEach(r => {
        if(r[0]) targetHtml += `<tr><td>${r[0]}</td><td>${r[1].toLocaleString()}</td></tr>`;
      });
      document.getElementById('tableTargetList').innerHTML = targetHtml;

      // Actual Box
      const o = data.overall;
      document.getElementById('actualTitle').innerText = 'Actual : ' + staff;
      document.getElementById('boxNew').innerHTML = renderActualBox('NewPost', o.newPost, o.diffNew, o.achieveNew);
      document.getElementById('boxBdbc').innerHTML = renderActualBox('BDBC', o.bdbc, o.diffBdbc, o.achieveBdbc);
      document.getElementById('boxApple').innerHTML = renderActualBox('Apple', o.apple, o.diffApple, o.achieveApple);
      document.getElementById('boxSmart').innerHTML = renderActualBox('SmartPhone', o.smart, o.diffSmart, o.achieveSmart);

      // Show all cards
      document.querySelectorAll('.card').forEach(c => c.style.display = 'block');
      document.getElementById('loader-overlay').style.display = 'none';
    }

    function renderActualBox(title, val, diff, ach) {
      return `
        <div style="text-align:center; padding: 10px; background: #fcfcfc; border-radius: 8px;">
          <div style="font-size:0.85rem; color:#888">${title}</div>
          <div style="font-size:1.2rem; font-weight:500">${val.toLocaleString()}</div>
          <div class="${diff < 0 ? 'negative':'positive'}" style="font-size:0.8rem">Diff: ${diff.toLocaleString()}</div>
          <div class="badge">${ach}% Achieve</div>
        </div>
      `;
    }
  </script>
</body>
</html>
